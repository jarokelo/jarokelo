var Mapbox=function(){"use strict";function o(o,n,t){if("string"==typeof w[o]){var e=$(w[o]);e.val(n),t&&e.trigger("input")}}function n(n,t){for(var e="Unnamed Road",a="",i=0,r=0;r<n.address_components.length;r++)switch(n.address_components[r].types[0]){case"street_number":a=n.address_components[r].long_name;break;case"postal_code":i=n.address_components[r].long_name;break;case"route":e=n.address_components[r].long_name}o("address",e+" "+a),o("street_name",e),o("post_code",i,!0),o("user_location",n.formatted_address,!0),o("latitude",t.lat),o("longitude",t.lng)}function t(o){d=new google.maps.Geocoder,d.geocode({location:o},function(t,e){e===google.maps.GeocoderStatus.OK&&t[0]&&(p.jumpTo({center:[o.lng,o.lat],zoom:p.getZoom()||f}),$("#reportform-user_location").val(t[0].formatted_address),n(t[0],o))})}function e(o){setTimeout(function(){o()},0)}function a(){e(function(){p.resize()})}function i(){["fullscreenchange","mozfullscreenchange","webkitfullscreenchange","msfullscreenchange"].forEach(function(o){document.addEventListener(o,function(){a()})})}function r(){return!!window.mapInitData.locationChangeHandler}function c(o){var n=document.createElementNS("http://www.w3.org/2000/svg","svg"),e=document.createElementNS("http://www.w3.org/2000/svg","use");e.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",window.STATIC_ASSETS_PATH+"/images/icons.svg#icon-magnify"),n.appendChild(e),n.style.height="43px",n.setAttribute("fill","#104A9C"),m=new mapboxgl.Marker(n,{draggable:o}),r()&&m.on("dragend",function(){t(m.getLngLat())})}function l(){if("none"!==$("[step=2]").css("display")){i();var o=$(".step--final").css("display");"block"===o?$(".mapboxgl-ctrl-group").hide():$(".mapboxgl-ctrl-group").show();var n=m.getLngLat();m.remove(),c("block"!==o),y(n)}}function s(){var o=$("#report-create-form");o.length>0&&o.yiiActiveForm("validate")}function g(o,n){var t=new google.maps.InfoWindow({map:p});t.setPosition(n),t.setContent(o?"Error: The Geolocation service failed.":"Error: Your browser doesn't support geolocation.")}mapboxgl.accessToken=window.mapboxToken;var d,m,u,p,f=window.mapInitData.zoom,w=window.mapInitData.selectors,v=window.mapInitData.center.lng,_=window.mapInitData.center.lat,h=!0,b=window.mapInitData.isReportEndPage||!1,y=function(o){m.setLngLat([o.lng,o.lat]).addTo(p)},k=function(o){t(o),y(o)};$(".button--large").on("click",function(){$("[step=1]:visible").length&&a(),e(l)}),$(".steps__icon").on("click",function(){e(function(){$("[step=2]:visible").length&&h&&(h=!1,a()),l()})});var x=function(){"string"==typeof w.user_location&&(u=new google.maps.places.Autocomplete($(w.user_location)[0],{types:["(cities)"],componentRestrictions:{country:"hu"}}),u.addListener("place_changed",function(){var o=u.getPlace();if(o.geometry&&o.geometry&&o.geometry.location){var n=o.geometry.location.lng(),t=o.geometry.location.lat();k({lng:n,lat:t})}}),$(w.show_on_map).on("click",function(){d.geocode({address:$(w.user_location).val()},function(o,n){if(n===google.maps.GeocoderStatus.OK&&o[0]){var t=o[0].geometry.location.lng(),e=o[0].geometry.location.lat();k({lng:t,lat:e}),s()}})}),$(w.show_me_on_map).on("click",function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(o){var n=o.coords.longitude,t=o.coords.latitude;k({lng:n,lat:t})}):g(!1,p.getCenter())}),$(w.user_location).on("keydown",function(o){13===o.keyCode&&(o.preventDefault(),$(w.show_on_map).trigger("click"))}))},C=function(){x(),p=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v11",center:[v,_],zoom:f}),o("zoom",f),p.on("zoom",function(){o("zoom",Math.round(p.getZoom()))}),c(!0),b?y({lng:v,lat:_}):k({lng:v,lat:_}),r()&&p.on("click",function(o){k({lng:o.lngLat.lng,lat:o.lngLat.lat})}),p.addControl(new mapboxgl.FullscreenControl),p.addControl(new mapboxgl.NavigationControl,"bottom-right"),$(document).trigger("mapReady",p),window._mapReady=p};return{initMap:C}}();